---
title: "A tour of **knitr** engines: **knitr** not only knits R"
author: "Christophe Dervieux"
date: userR!2022 - 22nd July
output:
  xaringan::moon_reader:
    keep_md: true
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    css: [useR, useR-fonts, custom.sass]
    nature:
      ratio: '16:9'
      # scale and scaleh
      beforeInit: "macros.js"
      highlightLines: true
      # highlightStyle: solarized-light
---

```{r xaringan-tachyons, echo=FALSE}
xaringanExtra::use_tachyons()
xaringanExtra::use_tile_view()
xaringanExtra::use_panelset()
xaringanExtra::use_freezeframe(responsive = FALSE)

# will be used several times in a cat engine
temp_file <- tempfile(fileext = ".Rmd")
# setting option for the several cat engine
knitr::opts_template$set(cat_md = list(
  engine.opts = list(file = temp_file, lang = "markdown"),
  echo = TRUE
))
# clean tempfile after a chunk computation
knitr::knit_hooks$set(rm_temp = function(before) {
  if (!before) unlink(temp_file)
})
```


# {knitr} in the the R Markdown workflow


.center.f3[.ba.b--blue.pa2.br4[`knitr::knit()`] + Pandoc (+ LaTeX for PDF) = `rmarkdown::render()`]

.pull-left[
.center[![:scale 80%, R Markdown wizard illustration by Alison Horst](rmarkdown_wizards.png)]
.source-fig.center[Source: https://github.com/allisonhorst/stats-illustrations]
]

.pull-right[
.center[![:scale 120%, Diagram showing the different step of rendering, using knitr first from Rmd to md, then Pandoc from md to output format like HTML, DOC and PDF (using LaTeX)](https://bookdown.org/yihui/rmarkdown-cookbook/images/workflow.png)]
.source-fig.center[
source: [R Markdown Cookbook](https://bookdown.org/yihui/rmarkdown-cookbook)
]
]


???

First a bit of context regarding **knitr** in the R Markdown process. R Markdown
is a tool to create some publication in several output formats by writing text
and executable code together in the same document. **knitr** is the tool in the
chain that will bring the literate programming feature by sewing source code and
result with other text in the knitting process.

---

# What is a {knitr} engine ? 

.subtitle[Using R as example]

.fl.w-50.pa2[
````{verbatim, lang = "markdown"}
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
````
]

.fl.w-50.pa2[
````{verbatim, lang = "markdown"}
```{<engine> <label>, <keys = values>}
<code content>
```
````
]

.fl.w-100[
* `<engine>` defines **how** the `<code content>` will be processed,
* `<keys = values>` are **configurations** for the engine,
* `<label>` is the name of the chunk</br>(equivalent to `label = <label>`).
]

???

Usually, R engine is used with **knitr** chunks to evaluate R code and showing source and outputs depending on providing options. Syntax looks this way with engine, a label and some option. An engine is the main component of **knitr** which will take code chunk content and process it so that source and results can be sewed in the document as text in the Markdown output. 

---

# There is more than just R !

.subtitle[Meet the other engines !]

A subset of available engines

```{r, R.options = list(width = 80)}
names(knitr::knit_engines$get())
```

.center[Let's take a tour! `r emo::ji("bus")`]

???

This principle is used for various engines and not just evaluating code chunk content with R. 

Let's take a tour !

---
layout: true

# Processing chunk content as-is

---

.subtitle[Meet the `verbatim` and `embed` engine]

```{r, echo = FALSE}
verbatim_content <- xfun::read_utf8("examples/verbatim-engine.Rmd")
verbatim_content <- gsub("(`{4}\\{)", "*\\1", verbatim_content)
```

.fl.w-50.pa2[
.ba[
.title-file[Include raw content in code block]
`````{verbatim, lang = "markdown", code = verbatim_content}
`````
]
]

.fl.w-50.pa2[
.ba[
.title-file[Include file content in code block]
`````{verbatim, lang = "markdown"}
*```{embed, file = "macros.js"}
```
`````
]
]

---

.subtitle[Look at the `asis` engine]

```{r, echo = FALSE}
asis_content <- knitr::knit_expand("examples/asis-engine.Rmd", value = "getRandomNumber() == 4")
asis_content <- gsub("\\n(```\\{asis)", "*\\1", asis_content)
```


.fl.w-60.pa2[
```{verbatim, code = asis_content}
```
]

.fl.w-40.pa2[
![](https://imgs.xkcd.com/comics/random_number.png)
.source-fig.right[https://xkcd.com/221/]
]

---
.subtitle[Look at the `asis` engine]

.fl.w-50.pa2[
.f3[For `getRandomNumber() != 4`]

```{verbatim, code = knitr::knit_child(text = knitr::knit_expand("examples/asis-engine.Rmd", value = "FALSE"))}
```
]

.fl.w-50.pa2[
.f3[For `getRandomNumber() == 4`]

```{verbatim, code = knitr::knit_child(text = knitr::knit_expand("examples/asis-engine.Rmd", value = "TRUE"))}
```
]

???

https://bookdown.org/yihui/rmarkdown-cookbook/eng-asis.html

---
layout: true

# Running other tools than R

---

.subtitle[Some built-in support]

.fl.w-50.pa2[
````{verbatim, lang = "markdown"}
```{python}
import os
os.env
```
````
]

.fl.w-50.pa2[
````{verbatim, lang = "markdown"}
```{stata}
sysuse auto
summarize
```
````
]

.fl.w-50.pa2[
````{verbatim, lang = "markdown"}
```{bash}
ls *.Rmd | head -n 5
```
````
]

.fl.w-50.pa2[
````{verbatim, lang = "markdown"}
```{perl}
$test = "jello world";
$test =~ s/j/h/;
print $test
```
````
]

.fl.w-100[
Chunk content is passed to the tools through `system2()`
]

---

.subtitle[Extend using `exec` engine]

Using `node` CLI (which require `.js` extension for scripts)

````{verbatim exec-rscript,  lang = "markdown"}
```{exec, command='node', engine.opts = list(ext = ".js")}
function Display(x) { console.log(`Your number is ${x}`); }
Display(100);
```
````
````markdown
```{r, results = "asis", echo = FALSE}
cat(stringr::str_trim(knitr::knit_child(text = knitr::knit_code$get("exec-rscript"), options = list(message = FALSE), quiet = TRUE)), sep = "\n")
```
````

More in [knitr-examples repo](https://github.com/yihui/knitr-examples): [`124-exec-engine.Rmd`](https://github.com/yihui/knitr-examples/blob/master/124-exec-engine.Rmd) 
???



The `exec` engine allows to execute an arbitrary command on the code chunk
content, optionally with arguments. If any, they are passed to `engine.opts` and
they could be one of the following:

The `exec` engine allows to execute an arbitrary command on the code chunk
content, optionally with arguments.

In your Rmd file

---
layout: false
# Adding dependencies

.subtitle[Include CSS and JS easily in HTML]

.fl.w-50.pa2[
````{verbatim, lang = "markdown"}
```{css, echo=FALSE}
/* Some CSS code that will will be included in HTML document a `<style>` tag. */
```
````
]

.fl.w-50.pa2[
````{verbatim, lang = "markdown"}
```{js, echo=FALSE}
// some JS code that will be included in HTML document in a`<script>` tag.
```
````
]

.fl.w-100.pa2[
Useful to customize output directly from the Rmd file without external resource
]


---
# Working with interoperability

.subtitle[More engine powered by other `r emo::ji("package")`]

* Use the `sql` engine to run queries using **DBI** on compatible databases,
* Use the `python` engine with **reticulate** to work seemlessly with R and Python chunks together,
* Use the `scss` or `sass` engine to process a chunk content with **sass** package to insert a CSS in HTML
* Use the `bslib` engine to add rules to **bslib** themes withing Rmd 

???

Some R packages are great to work with other tools like **DBI** for SQL queries, **reticulate** for working with Python from R, **sass** to work with SASS or **bslib** to customize Bootstrap website. **knitr** engines can be integrated with other Packages to bring more feature from within a Rmd document. 

---
layout: false

# Extending knitr with custom engines

.subtitle[Any package can provide custom way to process chunk content]
 
* **glue** has a `glue` engine to process chunk content as if passed to `glue::glue()` .icon-link[[`r fontawesome::fa("external-link")`](https://glue.tidyverse.org/articles/engines.html)]
* **texPreview** has a `texPreview` engine to render TeX snippet from code chunk, in non-LaTeX output document .icon-link[[`r fontawesome::fa("external-link")`](https://yonicd.github.io/texPreview/articles/engine.html)]
* **target** offers a `targets` engine so that Literate programming can be used to create a **targets** workflow (Target Markdown) .icon-link[[`r fontawesome::fa("external-link")`](https://books.ropensci.org/targets/markdown.html)]
* **d3** has a `d3` engine where chunk content will be processed with **r2d3** .icon-link[[`r fontawesome::fa("external-link")`](https://bookdown.org/yihui/rmarkdown-cookbook/d3.html#d3)]

???

https://yonicd.github.io/texPreview/

https://books.ropensci.org/targets/markdown.html

---
layout: true

# Extending knitr with custom engines

.subtitle[Registering custom engine]

---

```r
knitr::knit_engines$set(foo = function(options) {
  # the source code is in options$code; just do
  # whatever you want with it
})
```

* Use `knit_engines` to register by name
* All knitr options are passed to the engine
* Code chunk content is in `options$code`

---

.fl.w-100.pa2[
This engine will take the chunk content and make it upper case.
]

.fl.w-50.pa2[

```r
knitr::knit_engines$set(upper = function(options) {
  code <- paste(options$code, collapse = "\n")
  # Allow to hide result
  if (options$results == 'hide') return()
  # Allow to prevent processing
  if (options$eval) {}
    toupper(code) 
  } else {
    code
  }
})
```
]

.fl.w-50.pa2[


```{verbatim, lang = "markdown", code = xfun::read_utf8("examples/upper-engines.Rmd")[15:17]}
```

would output

```{verbatim, lang = "markdown", code = stringr::str_trim(knitr::knit_child("examples/upper-engines.Rmd", quiet = TRUE))}
```
]

---

.fl.w-100.pa2[A custom `py` engine to run `python`]

.fl.w-50.pa2[

```r
knitr::knit_engines$set(py = function(options) {
  code <- paste(options$code, collapse = '\n')
  out  <- system2(
    'python', c('-c', shQuote(code)), stdout = TRUE
  )
  knitr::engine_output(options, code, out)
})
```

]

.fl.w-50.pa2[


```{verbatim, lang = "markdown", code = xfun::read_utf8("examples/py-engine.Rmd")[12:15]}
```

.small.center[`r fontawesome::fa('arrow-down')`]

```{verbatim, lang = "markdown", code = stringr::str_trim(knitr::knit_child("examples/py-engine.Rmd", quiet = TRUE))}
```
]

???

https://bookdown.org/yihui/rmarkdown-cookbook/custom-engine.html

`knit_engines` is the way to register an engine by name for **knitr** to know it is available. Full set of `options` is passed and `options$code` contains the chunk content. Do what you need with that to process it and outputting a what will be sewed in the document. 

---
layout: false
class: center, middle, annexe
count: false

# Thank you !

.f3[https://cderv.rbind.io/slides/user2022-knitr-engines]

.f3[https://github.com/cderv/user2022-knitr-engines]

.pull-left[
.center[
`r fontawesome::fa("github")`</br>
[@cderv](https://github.com/cderv)
]
]

.pull-right[
.center[
`r fontawesome::fa("twitter")`</br>
[@chrisderv](https://twitter.com/chrisderv)
]
]


---
class: annexe
count: false

# Acknowledgement

```{r, include = FALSE}
gh_handle_to_link <- function(handle) sprintf("[@%s](https://github.com/%s)", handle, handle)
```


* Emily Riederer and Yihui Xie, for the R Markdown Cookbook
* Allison Horst for the illustrations.
* Alison Presman-Hill and Allison Horst for the **palmerpinguins** `r emo::ji("package")` and vignettes.
* `r gh_handle_to_link("cpsievert")` for the [**sass**](https://rstudio.github.io/sass/) `r emo::ji("package")`

```{r meta, echo=FALSE}
library(metathis)
meta() %>%
  meta_general(
    description = "A presentation at useR2021 about tips and tricks to enhanced a R Markdown document output.",
    generator = "xaringan and remark.js"
  ) %>% 
  meta_social(
    title = "Extend the functionality of your R Markdown document.",
    url = "https://user2021-enhanced-rmd.netlify.app/",
    image = "https://user2021-enhanced-rmd.netlify.app//whwir.png",
    image_alt = "The fourth slide of the presentation showing an illustration by Allison Horst about the little wizard implied in the process of cooking a Rmd document from Text & Code to produce a beautiful output.",
    og_type = "website",
    og_author = "Christophde Dervieux",
    twitter_card_type = "summary_large_image",
    twitter_creator = "@chrisderv"
  )
```
